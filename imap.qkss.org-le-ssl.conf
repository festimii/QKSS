<IfModule mod_ssl.c>
<VirtualHost *:443>
  ServerName imap.qkss.org

  SSLEngine on
  SSLCertificateFile    /etc/letsencrypt/live/imap.qkss.org/fullchain.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/imap.qkss.org/privkey.pem

  DocumentRoot /var/www/html
  <Directory /var/www/html>
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
  </Directory>

  # 1) Proxy API calls
  ProxyPreserveHost On
  ProxyPass        /api/  http://49.12.75.177:8082/api/
  ProxyPassReverse /api/  http://49.12.75.177:8082/api/

  # 2) Rewrite: serve existing files, else fallback to index.html
  RewriteEngine On

  # If it's an API request, skip the next rules entirely:
  RewriteCond %{REQUEST_URI}  ^/api/  [NC]
  RewriteRule .*               -       [L]

  # If the requested filename exists as file or directory, serve it:
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule .*               -       [L]

  # Otherwise rewrite everything to /index.html
  RewriteRule ^ /index.html [L]

  # Optional security headers
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  Header always set X-Frame-Options DENY
  Header always set X-Content-Type-Options nosniff
</VirtualHost>
</IfModule>
